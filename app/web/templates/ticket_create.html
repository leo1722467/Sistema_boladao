{% extends 'base.html' %}
{% block title %}Novo Chamado - Sistema Boladão{% endblock %}
{% block extra_head %}
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  .container { padding: 0; max-width: none; }
  .game-slider { position: relative; width: 100%; height: calc(100vh - 64px); overflow: hidden; }
  .slides { display: flex; width: 100%; height: 100%; transition: transform 0.5s ease-in-out; }
  .slide { flex: 0 0 100%; display: flex; flex-direction: column; gap: 14px; padding: 0; align-content: stretch; font-size: 20px; font-weight: bold; height: 100%; }
  .slide-title { font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 16px; }
  .square { border-radius: 16px; padding: 14px; box-shadow: 0 10px 28px rgba(0,0,0,0.15); }
  .sq-blue { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: #fff; }
  .sq-green { background: linear-gradient(135deg, #166534, #22c55e); color: #fff; }
  .sq-orange { background: linear-gradient(135deg, #7c2d12, #f59e0b); color: #fff; }
  .sq-purple { background: linear-gradient(135deg, #5b21b6, #a78bfa); color: #fff; }
  .sq-pink { background: linear-gradient(135deg, #9d174d, #ec4899); color: #fff; }
  .sq-slate { background: linear-gradient(135deg, #1f2937, #64748b); color: #fff; }
  .square h3 { font-size: 18px; font-weight: 800; margin-bottom: 8px; text-align: center; }
  .input, .select, .textarea { width: 100%; height: auto; padding: 8px 10px; border: none; border-radius: 10px; font-size: 14px; background: rgba(255,255,255,0.12); color: #fff; text-align: center; }
  .side-controls { position: absolute; top: 0; bottom: 0; display: flex; align-items: center; }
  .side-left { left: 0; }
  .side-right { right: 0; }
  .side-btn { display: inline-flex; align-items: center; justify-content: center; width: 48px; height: 100%; border: none; border-radius: 0; background: rgba(0,0,0,0.06); color: #0b0f19; cursor: pointer; }
  .btn { display: inline-flex; align-items: center; padding: 10px 18px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease; }
  .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; }
  .btn-ghost { background: rgba(0,0,0,0.06); color: #0b0f19; }
  .btn:hover { transform: translateY(-2px); }
  .progress { position: absolute; left: 24px; bottom: 24px; display: flex; gap: 10px; }
  .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(0,0,0,0.12); cursor: pointer; }
  .dot.active { background: #3b82f6; }
  .empty-state { text-align: center; padding: 40px 20px; }
  .center-step { display: flex; flex: 1; align-items: stretch; justify-content: center; }
  .center-box { width: 100%; max-width: none; height: 100%; display: flex; }
  .square { height: 100%; width: 100%; display: flex; flex-direction: column; flex: 1; }
  .textarea { flex: 1; resize: none; }
  .options-grid { display: grid; gap: 12px; height: 100%; align-content: stretch; grid-auto-rows: 120px; }
  .option-btn { display: flex; align-items: center; justify-content: center; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.12); color: #fff; font-weight: 600; cursor: pointer; border: 2px solid transparent; height: 100%; }
  .option-btn.active { border-color: #3b82f6; }
</style>
{% endblock %}
{% block topbar_left %}
<h1 class="page-title">Novo Chamado</h1>
{% endblock %}
{% block content %}
  <div class="game-slider">
        <div id="slides" class="slides">
          <div class="slide"><div class="center-step">Tipo de Ativo</div><div class="options-grid" id="tipoGrid"></div></div>
          <div class="slide"><div class="center-step">Local de Instalação</div><div class="options-grid" id="localGrid"></div></div>
          <div class="slide">
            <h3 class="slide-title">Ativo</h3>
            <div class="center-step"><div class="center-box">
              <div class="square sq-slate">
                <input id="tagInput" class="input" placeholder="Digite a TAG para filtrar (ex: CAM-192)" />
              </div>
            </div></div>
            <div class="options-grid" id="assetGrid"></div>
          </div>
          <div class="slide"><div class="center-step">Defeito</div><div class="options-grid" id="defeitoGrid"></div></div>
          <div class="slide"><h3 class="slide-title">Descrição</h3><div class="center-step"><div class="center-box"><div class="square sq-green"><textarea id="descricaoInput" class="textarea" placeholder="Conte os detalhes, sintomas, contexto"></textarea></div></div></div><div class="square sq-blue" style="margin:12px;"><h3 style="margin-bottom:8px;">Sugestões de Artigos</h3><div id="kbSuggestBox" class="empty-state" style="text-align:left;">Digite o título/descrição para ver sugestões</div></div></div>
          <div class="slide"><div class="center-step">Prioridade</div><div class="options-grid" id="priorityGrid"></div></div>
          <div class="slide"><div class="square sq-blue" style="height:100%;"><h3 style="margin-bottom:8px;">Resumo</h3><div id="summaryBox" class="empty-state" style="padding: 0; text-align: left;"></div><div style="margin-top:12px;"><button id="createTicketBtn" class="btn btn-primary"><i class="fas fa-ticket"></i> Criar Chamado</button></div></div></div>
        </div>
        <div class="side-controls side-left"><button id="prevBtn" class="side-btn"><i class="fas fa-chevron-left"></i></button></div>
        <div class="side-controls side-right"><button id="nextBtn" class="side-btn"><i class="fas fa-chevron-right"></i></button></div>
        <div class="progress">
          <div id="dot0" class="dot active"></div>
          <div id="dot1" class="dot"></div>
          <div id="dot2" class="dot"></div>
          <div id="dot3" class="dot"></div>
          <div id="dot4" class="dot"></div>
          <div id="dot5" class="dot"></div>
          <div id="dot6" class="dot"></div>
        </div>
      </div>
      <div id="resultBox" class="empty-state" style="display:none;"></div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
      const hasToken = document.cookie.split('; ').some(row => row.startsWith('access_token='))
      if (!hasToken) { window.location.href = '/'; return }
      window.addEventListener('error', (e) => { try { console.error('Unhandled error:', e.message, e.error || null) } catch {} })
      window.addEventListener('unhandledrejection', (e) => { try { console.error('Unhandled rejection:', e.reason) } catch {} })
      await loadOptions()
      document.getElementById('createTicketBtn').addEventListener('click', submitTicket)
    })

    async function logFetchError(res, url, payload) {
      try {
        const ct = res.headers.get('content-type') || ''
        const body = ct.includes('application/json') ? await res.json() : await res.text()
        console.error('Fetch error', { url, status: res.status, statusText: res.statusText, payload, body })
      } catch (err) {
        console.error('Fetch error (body parse failed)', { url, status: res.status, statusText: res.statusText, payload })
      }
    }

    let prOpts = []
    let tipoOpts = []
    let localOpts = []
    let atOpts = []
    let defeitoOpts = []
    let meProfile = null
    let selectedPriorityId = null
    let selectedTipoId = null
    let selectedLocalId = null
    let selectedAssetId = null
    let selectedDefeitoId = null
    let selectedAgentId = 1
    let selectedOwnerId = null
    async function loadOptions() {
      try {
        const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='))
        const token = tokenCookie ? tokenCookie.split('=')[1] : null
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {}
        const meRes = await fetch('/auth/me', { credentials: 'include', headers })
        meProfile = meRes.ok ? await meRes.json() : null
        selectedOwnerId = meProfile?.contato_id || null
        const prRes = await fetch('/admin/Prioridade/items', { credentials: 'include', headers })
        prOpts = prRes.ok ? await prRes.json() : []
        const tipoRes = await fetch('/admin/TipoAtivo/items', { credentials: 'include', headers })
        tipoOpts = tipoRes.ok ? await tipoRes.json() : []
        const localRes = await fetch('/admin/LocalInstalacao/items', { credentials: 'include', headers })
        localOpts = localRes.ok ? await localRes.json() : []
        const atRes = await fetch('/api/helpdesk/assets', { credentials: 'include', headers })
        atOpts = atRes.ok ? await atRes.json() : []
        if (!meRes.ok) await logFetchError(meRes, '/auth/me')
        if (!prRes.ok) await logFetchError(prRes, '/admin/Prioridade/items')
        if (!tipoRes.ok) await logFetchError(tipoRes, '/admin/TipoAtivo/items')
        if (!localRes.ok) await logFetchError(localRes, '/admin/LocalInstalacao/items')
        if (!atRes.ok) await logFetchError(atRes, '/api/helpdesk/assets')
        renderOptionGrids()
      } catch (e) {
        console.error('Erro ao carregar opções', e)
      }
    }
    // Dynamic font size for text inputs based on length
    function adjustFont(el, max=48, min=16) {
      const len = (el.value || '').length
      const size = Math.max(min, Math.round(max - len * 0.6))
      el.style.fontSize = size + 'px'
      el.style.lineHeight = (size + 10) + 'px'
    }
    const tagEl = document.getElementById('tagInput')
    const descEl = document.getElementById('descricaoInput')
    tagEl.addEventListener('input', () => { filterAssetsByTag(tagEl.value); computeTitle() })
    descEl.addEventListener('input', () => { adjustFont(descEl, 42, 16); suggestKB() })
    descEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); nextSlide() } })
    adjustFont(descEl, 42, 16)
    function renderOptionGrids() {
      const pGrid = document.getElementById('priorityGrid')
      const tipoGrid = document.getElementById('tipoGrid')
      const localGrid = document.getElementById('localGrid')
      const sGrid = document.getElementById('assetGrid')
      const dGrid = document.getElementById('defeitoGrid')
      const randomGradient = () => { const h = Math.floor(Math.random()*360); const c1 = `hsl(${h}, 70%, 45%)`; const c2 = `hsl(${(h+20)%360}, 70%, 55%)`; return `linear-gradient(135deg, ${c1}, ${c2})` }
      const getCategoryBackground = (o) => {
        const isActive = o && (o.ativo === true || o.ativo === 1 || o.ativo === 'true')
        if (isActive && o && o.cor) {
          return `linear-gradient(135deg, ${o.cor}, ${o.cor})`
        }
        return randomGradient()
      }
      pGrid.innerHTML = prOpts.map(o => { const bg = randomGradient(); return `<div class="option-btn ${selectedPriorityId===o.id?'active':''}" onclick="selectPriority(${o.id})" style="background:${bg}">${o.nome}</div>` }).join('')
      tipoGrid.innerHTML = tipoOpts.map(o => { const bg = randomGradient(); return `<div class="option-btn ${selectedTipoId===o.id?'active':''}" onclick="selectTipo(${o.id})" style="background:${bg}">${o.nome || 'Tipo'} #${o.id}</div>` }).join('')
      localGrid.innerHTML = localOpts.map(o => { const bg = randomGradient(); return `<div class="option-btn ${selectedLocalId===o.id?'active':''}" onclick="selectLocal(${o.id})" style="background:${bg}">${o.nome || 'Local'} #${o.id}</div>` }).join('')
      sGrid.innerHTML = filteredAssets().map(o => { const bg = randomGradient(); return `<div class="option-btn ${selectedAssetId===o.id?'active':''}" onclick="selectAsset(${o.id})" style="background:${bg}">${o.tag || o.serial_text || o.descricao || 'Ativo'} #${o.id}</div>` }).join('')
      dGrid.innerHTML = (defeitoOpts.length ? defeitoOpts : [{id:0,nome:'Nenhum defeito cadastrado'}]).map(o => { const bg = randomGradient(); const disabled = o.id===0; return `<div class="option-btn ${selectedDefeitoId===o.id?'active':''}" onclick="${disabled?'':`selectDefeito(${o.id})`}" style="background:${bg};${disabled?'opacity:0.6;cursor:not-allowed;':''}">${o.nome}</div>` }).join('')
      const setGrid = (grid, count) => {
        const cols = Math.ceil(Math.sqrt(Math.max(count,1)))
        const rows = Math.ceil(count / cols)
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`
        grid.style.gridTemplateRows = `repeat(${rows || 1}, 1fr)`
      }
      setGrid(pGrid, prOpts.length)
      setGrid(tipoGrid, tipoOpts.length)
      setGrid(localGrid, localOpts.length)
      setGrid(sGrid, filteredAssets().length)
      setGrid(dGrid, defeitoOpts.length)
    }
    function selectPriority(id) { selectedPriorityId = id; renderOptionGrids(); nextSlide() }
    function selectTipo(id) { selectedTipoId = id; selectedAssetId = null; loadDefeitosForTipo(id); renderOptionGrids(); nextSlide() }
    function selectLocal(id) { selectedLocalId = id; selectedAssetId = null; renderOptionGrids(); nextSlide() }
    function selectAsset(id) { selectedAssetId = id; computeTitle(); renderOptionGrids(); nextSlide() }
    function selectDefeito(id) { selectedDefeitoId = id; computeTitle(); renderOptionGrids(); nextSlide() }

    function filteredAssets() {
      const tagFilter = (tagEl.value || '').trim().toLowerCase()
      return (atOpts || []).filter(a => {
        const matchesTipo = !selectedTipoId || (a.tipo && a.tipo.id === selectedTipoId)
        const matchesLocal = !selectedLocalId || (a.local_instalacao && a.local_instalacao.id === selectedLocalId)
        const matchesTag = !tagFilter || ((a.tag||'').toLowerCase().includes(tagFilter) || (a.serial_text||'').toLowerCase().includes(tagFilter))
        return matchesTipo && matchesLocal && matchesTag
      })
    }
    function filterAssetsByTag(tag) { renderOptionGrids() }
    async function loadDefeitosForTipo(tipoId) {
      try {
        const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='))
        const token = tokenCookie ? tokenCookie.split('=')[1] : null
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {}
        let res = await fetch(`/api/helpdesk/defeitos?tipo_ativo_id=${tipoId}`, { credentials: 'include', headers })
        if (res.ok) {
          defeitoOpts = (await res.json()).defeitos
        } else {
          await logFetchError(res, `/api/helpdesk/defeitos?tipo_ativo_id=${tipoId}`)
          res = await fetch('/admin/ChamadoDefeito/items', { credentials: 'include', headers })
          const all = res.ok ? await res.json() : []
          if (!res.ok) await logFetchError(res, '/admin/ChamadoDefeito/items')
          defeitoOpts = all.filter(d => String(d.tipo_ativo_id) === String(tipoId)).map(d => ({ id: d.id, nome: d.nome }))
        }
      } catch (e) { defeitoOpts = [] }
    }
    function computeTitle() {
      const asset = (atOpts || []).find(x => x.id === selectedAssetId)
      const assetLabel = asset ? (asset.tag || asset.serial_text || asset.descricao || `Ativo #${asset.id}`) : (tagEl.value || '').trim()
      const defeito = (defeitoOpts || []).find(x => x.id === selectedDefeitoId)
      const defeitoLabel = defeito ? defeito.nome : ''
      return [assetLabel, defeitoLabel].filter(Boolean).join(' | ')
    }
    async function suggestKB() {
      try {
        const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='))
        const token = tokenCookie ? tokenCookie.split('=')[1] : null
        const headers = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }
        const payload = { titulo: computeTitle(), descricao: descEl.value }
        const res = await fetch('/api/helpdesk/kb/suggest', { method:'POST', credentials:'include', headers, body: JSON.stringify(payload) })
        const box = document.getElementById('kbSuggestBox')
        if (!res.ok) { box.innerHTML = 'Nenhuma sugestão disponível'; return }
        const items = await res.json()
        if (!items.length) { box.innerHTML = 'Nenhuma sugestão encontrada'; return }
        box.innerHTML = items.map(a => `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.15);"><a href="/kb/${a.id}" target="_blank" style="color:#e2e8f0;text-decoration:none;font-weight:600;">${a.titulo}</a><div style="opacity:.8;">${a.resumo||''}</div></div>`).join('')
      } catch (e) {}
    }

    async function submitTicket() {
      try {
        const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='))
        const token = tokenCookie ? tokenCookie.split('=')[1] : null
        const headers = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' }
        const payload = {
          titulo: computeTitle() || '-',
          descricao: document.getElementById('descricaoInput').value,
          prioridade_id: selectedPriorityId,
          status_id: 1,
          agente_contato_id: 1,
          proprietario_contato_id: selectedOwnerId || null,
          ativo_id: selectedAssetId || null
        }
        const res = await fetch('/api/helpdesk/tickets', { method: 'POST', credentials: 'include', headers, body: JSON.stringify(payload) })
        if (!res.ok) {
          await logFetchError(res, '/api/helpdesk/tickets', payload)
          let msg = 'Erro ao criar chamado'
          try {
            const ct = res.headers.get('content-type') || ''
            const err = ct.includes('application/json') ? await res.json() : await res.text()
            const detail = (typeof err === 'string') ? err : (err && err.detail)
            if (res.status === 401) msg = 'Sessão expirada. Faça login novamente.'
            else if (res.status === 403) msg = 'Sem permissão para criar chamado.'
            else if (detail) msg = detail
          } catch {}
          throw new Error(msg)
        }
        const data = await res.json()
        console.info('Chamado criado com sucesso', data)
        document.getElementById('resultBox').style.display = 'block'
        document.getElementById('resultBox').innerHTML = `<i class="fas fa-check-circle"></i><h3>Chamado criado</h3><p>Número: ${data.numero || data.id} · Título: ${data.titulo}</p>`
        setTimeout(() => { window.location.href = '/tickets' }, 900)
      } catch (error) {
        console.error('Falha ao criar chamado', error)
        const box = document.getElementById('resultBox')
        box.style.display = 'block'
        box.innerHTML = `<i class="fas fa-exclamation-triangle"></i><h3>Erro</h3><p>${error.message}</p>`
      }
    }

    let currentIndex = 0
    function nextSlide() { currentIndex = Math.min(6, currentIndex + 1); updateSlider() }
    function goToSlide(i) { currentIndex = Math.max(0, Math.min(6, i)); updateSlider() }
    function updateSlider() {
      document.getElementById('slides').style.transform = `translateX(-${currentIndex * 100}%)`
      for (let i = 0; i < 7; i++) {
        const d = document.getElementById('dot' + i)
        if (d) d.classList.toggle('active', i === currentIndex)
      }
      if (currentIndex === 6) {
        const titulo = (computeTitle() || '').trim()
        const descricao = (document.getElementById('descricaoInput').value || '').trim()
        const prText = (prOpts.find(x=>x.id===selectedPriorityId)?.nome) || '-'
        const agText = '#1'
        const propText = meProfile?.nome || '-'
        const atText = (atOpts.find(x=>x.id===selectedAssetId)?.tag) || (atOpts.find(x=>x.id===selectedAssetId)?.serial_text) || '-'
        const tipoText = (tipoOpts.find(x=>x.id===selectedTipoId)?.nome) || '-'
        const localText = (localOpts.find(x=>x.id===selectedLocalId)?.nome) || '-'
        const defeitoText = (defeitoOpts.find(x=>x.id===selectedDefeitoId)?.nome) || '-'
        document.getElementById('summaryBox').innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:stretch;">
            <div class="square sq-slate"><h3>Título</h3><div class="empty-state">${titulo || '-'}</div></div>
            <div class="square sq-green"><h3>Prioridade</h3><div class="empty-state">${prText}</div></div>
            <div class="square sq-pink"><h3>Agente</h3><div class="empty-state">${agText}</div></div>
            <div class="square sq-blue"><h3>Proprietário</h3><div class="empty-state">${propText}</div></div>
            <div class="square sq-green"><h3>Ativo</h3><div class="empty-state">${atText}</div></div>
            <div class="square sq-purple"><h3>Tipo</h3><div class="empty-state">${tipoText}</div></div>
            <div class="square sq-purple"><h3>Local</h3><div class="empty-state">${localText}</div></div>
            <div class="square sq-purple"><h3>Defeito</h3><div class="empty-state">${defeitoText}</div></div>
            <div class="square sq-orange" style="grid-column:1/-1;max-height:180px;overflow:auto;"><h3>Descrição</h3><div class="empty-state">${descricao || '-'}</div></div>
          </div>
        `
      }
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') { currentIndex = Math.min(6, currentIndex + 1); updateSlider() }
      if (e.key === 'ArrowLeft') { currentIndex = Math.max(0, currentIndex - 1); updateSlider() }
    })
    document.getElementById('nextBtn').addEventListener('click', () => { currentIndex = Math.min(6, currentIndex + 1); updateSlider() })
    document.getElementById('prevBtn').addEventListener('click', () => { currentIndex = Math.max(0, currentIndex - 1); updateSlider() })
    for (let i = 0; i < 7; i++) { const d = document.getElementById('dot' + i); if (d) d.addEventListener('click', () => goToSlide(i)) }
    updateSlider()
  </script>
{% endblock %}
