{% extends 'base.html' %}
{% block title %}Editar Chamado{% endblock %}
{% block extra_head %}
<style>
  .container { padding: 30px; max-width: 1200px; margin: 0 auto; }
  .form-group { margin-bottom: 16px; }
  .label { display:block; font-size:14px; font-weight:500; margin-bottom:8px; color:#555; }
  .input, .select, .textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
  .textarea { min-height: 100px; }
  .actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 20px; }
  .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
  .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color:#fff; }
  .btn-secondary { background:#6c757d; color:#fff; }
  .badge { display:inline-block; padding:4px 8px; border-radius:12px; background:#e9ecef; color:#555; font-size:12px; }
  .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; }
  .error { background:#fdecea; color:#b00020; padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
  .success { background:#eafaf1; color:#1e7e34; padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
</style>
{% endblock %}
{% block topbar_left %}
<div class="title"><i class="fas fa-edit"></i> Editar Chamado <span id="ticketNumber" class="badge"></span></div>
{% endblock %}
{% block content %}
  <div id="errorBox" class="error"></div>
  <div id="successBox" class="success"></div>
  <div class="form-group">
    <label class="label">Título</label>
    <input id="tituloInput" class="input" />
  </div>
  <div class="form-group">
    <label class="label">Descrição</label>
    <textarea id="descricaoInput" class="textarea"></textarea>
  </div>
  <div class="row">
    <div class="form-group">
      <label class="label">Status</label>
      <select id="statusSelect" class="select">
        <option value="">Selecione...</option>
      </select>
    </div>
    <div class="form-group">
      <label class="label">Prioridade</label>
      <select id="prioritySelect" class="select">
        <option value="">Selecione...</option>
      </select>
    </div>
    <div class="form-group">
      <label class="label">Agente</label>
      <select id="agenteSelect" class="select">
        <option value="">Não atribuído</option>
      </select>
    </div>
  </div>
  <div class="form-group">
    <label class="label">Comentário</label>
    <textarea id="commentInput" class="textarea" placeholder="Explique a alteração (opcional)"></textarea>
  </div>
  <div class="actions">
    <button class="btn btn-primary" id="saveBtn"><i class="fas fa-save"></i> Salvar</button>
    <a class="btn btn-secondary" href="/tickets"><i class="fas fa-times"></i> Cancelar</a>
  </div>
{% endblock %}
{% block scripts %}
<script>
    const ticketId = (function(){
      const parts = window.location.pathname.split('/');
      return parseInt(parts[parts.indexOf('chamado') + 1], 10);
    })();
    let currentUser = null;
    let isAdminEditor = false;

    function showError(msg) { const box = document.getElementById('errorBox'); box.textContent = msg; box.style.display = 'block'; }
    function hideError() { const box = document.getElementById('errorBox'); box.style.display = 'none'; }
    function showSuccess(msg) { const box = document.getElementById('successBox'); box.textContent = msg; box.style.display = 'block'; setTimeout(()=> box.style.display='none', 3000); }

    async function apiHeaders() {
      const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='));
      const token = tokenCookie ? tokenCookie.split('=')[1] : null;
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return headers;
    }

    async function getMe() {
      const headers = await apiHeaders();
      const r = await fetch('/auth/me', { credentials: 'include', headers });
      if (!r.ok) throw new Error('Falha ao carregar usuário');
      return await r.json();
    }

    async function loadUserGreeting() {
      try {
        const me = await getMe();
        const nome = me?.nome || me?.user?.nome || me?.email || 'Usuário';
        document.getElementById('userGreeting').textContent = `Bem-vindo, ${nome}`;
        const initial = String(nome).trim().charAt(0).toUpperCase() || 'U';
        document.getElementById('userAvatar').textContent = initial;
      } catch {}
    }

    async function loadTicket() {
      hideError();
      try {
        
        // resolve current user and compute editor rights
        try {
          currentUser = await getMe();
          const empresaId = Number(currentUser.empresa_id || currentUser.tenant?.empresa_id || 0);
          const role = (currentUser.role || '').toLowerCase();
          isAdminEditor = empresaId === 1 || role === 'admin' || role === 'agent';
        } catch {}

        const headers = await apiHeaders();
        const r = await fetch(`/api/helpdesk/tickets/${ticketId}`, { credentials: 'include', headers });
        let t;
        if (!r.ok) {
          if (r.status === 401) { window.location.href = '/'; return; }
          // Fallback: try list endpoint and prefill from it
          const rl = await fetch(`/api/helpdesk/tickets?limit=200`, { credentials: 'include', headers });
          if (rl.ok) {
            const data = await rl.json();
            const found = (data.tickets || []).find(x => x.id === ticketId);
            if (found) {
              t = found;
              hideError();
            } else {
              showError('Sem permissão ou chamado não encontrado.');
              return;
            }
          } else {
            showError('Sem permissão para visualizar chamado.');
            return;
          }
        } else {
          t = await r.json();
        }
        // Derive empresa from ticket number pattern E{empresa}{ORIGIN}-{N} to grant admin edit when empresa=1
        try {
          if (!isAdminEditor && t && typeof t.numero === 'string') {
            const m = /^E(\d+)[A-Z]+-\d+$/i.exec(t.numero.trim());
            if (m && parseInt(m[1], 10) === 1) {
              isAdminEditor = true;
            }
          }
        } catch {}
        document.getElementById('ticketNumber').textContent = t.numero || `#${ticketId}`;
        document.getElementById('tituloInput').value = t.titulo || '';
        document.getElementById('descricaoInput').value = t.descricao || '';
        await loadStatusOptions(t.status_id || null);
        await loadPriorityOptions(t.prioridade_id || null);
        await loadAgentOptions((t.agente && t.agente.id) ? t.agente.id : null);
        await loadUserGreeting();

        // if not admin/agent, disable editing except comment
        if (!isAdminEditor) {
          document.getElementById('tituloInput').setAttribute('disabled', 'disabled');
          document.getElementById('descricaoInput').setAttribute('disabled', 'disabled');
          document.getElementById('statusSelect').setAttribute('disabled', 'disabled');
          document.getElementById('prioritySelect').setAttribute('disabled', 'disabled');
          document.getElementById('agenteSelect').setAttribute('disabled', 'disabled');
          showError('Você só pode adicionar comentários aos seus chamados.');
        } else {
          document.getElementById('errorBox').style.display = 'none';
          document.getElementById('tituloInput').removeAttribute('disabled');
          document.getElementById('descricaoInput').removeAttribute('disabled');
          document.getElementById('statusSelect').removeAttribute('disabled');
          document.getElementById('prioritySelect').removeAttribute('disabled');
          document.getElementById('agenteSelect').removeAttribute('disabled');
        }
      } catch (e) {
        showError('Erro ao carregar chamado');
      }
    }

    async function loadAgentOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/agente_contato_id?empresa_id=1', { credentials: 'include', headers });
        if (!r.ok) return; 
        const options = await r.json();
        const select = document.getElementById('agenteSelect');
        // Clear existing (keep first 'Não atribuído')
        select.innerHTML = '<option value="">Não atribuído</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function loadStatusOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/status_id', { credentials: 'include', headers });
        if (!r.ok) return;
        const options = await r.json();
        const select = document.getElementById('statusSelect');
        select.innerHTML = '<option value="">Selecione...</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function loadPriorityOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/prioridade_id', { credentials: 'include', headers });
        if (!r.ok) return;
        const options = await r.json();
        const select = document.getElementById('prioritySelect');
        select.innerHTML = '<option value="">Selecione...</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function saveTicket() {
      hideError();
      try {
        const payload = {};
        const titulo = document.getElementById('tituloInput').value.trim();
        const descricao = document.getElementById('descricaoInput').value.trim();
        const statusId = document.getElementById('statusSelect').value;
        const statusText = (function(){
          const el = document.getElementById('statusSelect');
          const opt = el && el.selectedOptions && el.selectedOptions[0] ? el.selectedOptions[0] : null;
          return (opt ? opt.text : '').trim().toLowerCase();
        })();
        const prioridadeId = document.getElementById('prioritySelect').value;
        const agenteId = document.getElementById('agenteSelect').value;
        const comment = document.getElementById('commentInput').value;
        const commentTrim = (comment || '').trim();
        if (isAdminEditor) {
          if (titulo) payload.titulo = titulo;
          if (descricao) payload.descricao = descricao;
          if (statusId) payload.status_id = parseInt(statusId, 10);
          if (prioridadeId) payload.prioridade_id = parseInt(prioridadeId, 10);
          if (agenteId) payload.agente_contato_id = parseInt(agenteId, 10);
          if (comment) payload.comment = comment;
        } else {
          if (!commentTrim) {
            throw new Error('Como solicitante, você só pode enviar comentários.');
          }
          payload.comment = commentTrim;
        }

        const requiresComment = (function(s){
          if (!s) return false;
          const n = s.toLowerCase();
          // Pending Customer / Aguardando Cliente / Em espera and Resolved / Resolvido
          return (
            n.includes('aguardando cliente') || n.includes('em espera') || n.includes('pending customer') ||
            n.includes('resolved') || n.includes('resolvido')
          );
        })(statusText);

        if (requiresComment && !commentTrim) {
          throw new Error('Informe um comentário para esta mudança de status.');
        }
        if (commentTrim && !payload.comment) {
          payload.comment = commentTrim;
        }

        const headers = await apiHeaders();
        const r = await fetch(`/api/helpdesk/tickets/${ticketId}`, {
          method: 'PUT', credentials: 'include', headers, body: JSON.stringify(payload)
        });
        if (!r.ok) {
          let msg = 'Falha ao salvar alterações';
          try {
            const err = await r.json();
            // FastAPI detail can be a string or object
            if (typeof err === 'string') msg = err || msg;
            else if (typeof err?.detail === 'string') msg = err.detail || msg;
            else if (typeof err?.detail?.message === 'string') msg = err.detail.message || msg;
          } catch {}
          throw new Error(msg);
        }
        showSuccess('Chamado atualizado com sucesso');
        setTimeout(()=> { window.location.href = '/tickets'; }, 1000);
      } catch (e) { showError(e.message || 'Erro ao salvar'); }
    }

    document.getElementById('saveBtn').addEventListener('click', saveTicket);
    document.addEventListener('DOMContentLoaded', loadTicket);
  </script>
{% endblock %}
</body>
</html>
