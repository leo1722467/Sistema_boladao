<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Chamado</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #333; }
    .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; z-index: 1000; transition: transform 0.3s ease; overflow-y: auto; }
    .sidebar.collapsed { transform: translateX(-280px); }
    .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-nav { padding: 20px 0; }
    .nav-item { display:block; padding:12px 20px; color:white; text-decoration:none; transition: all 0.3s ease; border-left:3px solid transparent; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); border-left-color:#3498db; }
    .nav-item i { width:20px; margin-right:10px; }
    .main-content { margin-left:280px; min-height:100vh; transition: margin-left 0.3s ease; }
    .main-content.expanded { margin-left:0; }
    .top-bar { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .menu-toggle { background:none; border:none; font-size:20px; cursor:pointer; color:#666; }
    .title { font-size: 22px; font-weight: 600; color:#2c3e50; }
    .user-menu { display:flex; align-items:center; gap:15px; }
    .user-avatar { width:40px; height:40px; border-radius:50%; background: linear-gradient(135deg, #3498db, #2980b9); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; }
    .container { padding: 30px; max-width: 1200px; margin: 0 auto; }
    .form-group { margin-bottom: 16px; }
    .label { display:block; font-size:14px; font-weight:500; margin-bottom:8px; color:#555; }
    .input, .select, .textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
    .textarea { min-height: 100px; }
    .actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 20px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
    .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    .badge { display:inline-block; padding:4px 8px; border-radius:12px; background:#e9ecef; color:#555; font-size:12px; }
    .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; }
    .error { background:#fdecea; color:#b00020; padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
    .success { background:#eafaf1; color:#1e7e34; padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Sistema Boladão</h2>
      <p>Gestão de Helpdesk</p>
    </div>
    <nav class="sidebar-nav">
      <a href="/dashboard" class="nav-item"><i class="fas fa-tachometer-alt"></i>Dashboard</a>
      <a href="/assets" class="nav-item"><i class="fas fa-desktop"></i>Ativos</a>
      <a href="/tickets" class="nav-item active"><i class="fas fa-ticket-alt"></i>Chamados</a>
      <a href="/service-orders" class="nav-item"><i class="fas fa-tools"></i>Ordens de Serviço</a>
      <a href="/inventory" class="nav-item"><i class="fas fa-boxes"></i>Estoque</a>
      <a href="/integrations" class="nav-item"><i class="fas fa-plug"></i>Integrações</a>
      <a href="/analytics" class="nav-item"><i class="fas fa-chart-bar"></i>Relatórios</a>
      <a href="/web/tables" class="nav-item"><i class="fas fa-database"></i>Admin</a>
    </nav>
  </div>

  <div class="main-content" id="mainContent">
    <div class="top-bar">
      <div style="display:flex; align-items:center; gap:15px;">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <div class="title"><i class="fas fa-edit"></i> Editar Chamado <span id="ticketNumber" class="badge"></span></div>
      </div>
      <div class="user-menu">
        <span id="userGreeting">Bem-vindo, Usuário</span>
        <div class="user-avatar" id="userAvatar">U</div>
        <a href="/web/logout" class="btn btn-primary"><i class="fas fa-sign-out-alt"></i> Sair</a>
      </div>
    </div>

    <div class="container">

    <div id="errorBox" class="error"></div>
    <div id="successBox" class="success"></div>

    <div class="form-group">
      <label class="label">Título</label>
      <input id="tituloInput" class="input" />
    </div>

    <div class="form-group">
      <label class="label">Descrição</label>
      <textarea id="descricaoInput" class="textarea"></textarea>
    </div>

    <div class="row">
      <div class="form-group">
        <label class="label">Status</label>
        <select id="statusSelect" class="select">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Prioridade</label>
        <select id="prioritySelect" class="select">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Agente</label>
        <select id="agenteSelect" class="select">
          <option value="">Não atribuído</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="label">Comentário</label>
      <textarea id="commentInput" class="textarea" placeholder="Explique a alteração (opcional)"></textarea>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="saveBtn"><i class="fas fa-save"></i> Salvar</button>
      <a class="btn btn-secondary" href="/tickets"><i class="fas fa-times"></i> Cancelar</a>
    </div>
    </div>
  </div>

  <script>
    const ticketId = (function(){
      const parts = window.location.pathname.split('/');
      return parseInt(parts[parts.indexOf('chamado') + 1], 10);
    })();
    let currentUser = null;
    let isAdminEditor = false;

    function showError(msg) { const box = document.getElementById('errorBox'); box.textContent = msg; box.style.display = 'block'; }
    function hideError() { const box = document.getElementById('errorBox'); box.style.display = 'none'; }
    function showSuccess(msg) { const box = document.getElementById('successBox'); box.textContent = msg; box.style.display = 'block'; setTimeout(()=> box.style.display='none', 3000); }

    async function apiHeaders() {
      const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token='));
      const token = tokenCookie ? tokenCookie.split('=')[1] : null;
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return headers;
    }

    async function getMe() {
      const headers = await apiHeaders();
      const r = await fetch('/auth/me', { credentials: 'include', headers });
      if (!r.ok) throw new Error('Falha ao carregar usuário');
      return await r.json();
    }

    async function loadUserGreeting() {
      try {
        const me = await getMe();
        const nome = me?.nome || me?.user?.nome || me?.email || 'Usuário';
        document.getElementById('userGreeting').textContent = `Bem-vindo, ${nome}`;
        const initial = String(nome).trim().charAt(0).toUpperCase() || 'U';
        document.getElementById('userAvatar').textContent = initial;
      } catch {}
    }

    async function loadTicket() {
      hideError();
      try {
        document.getElementById('menuToggle').addEventListener('click', function(){
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.getElementById('mainContent');
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('expanded');
        });
        if (window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.add('collapsed');
          document.getElementById('mainContent').classList.add('expanded');
        }

        // resolve current user and compute editor rights
        try {
          currentUser = await getMe();
          const empresaId = Number(currentUser.empresa_id || currentUser.tenant?.empresa_id || 0);
          const role = (currentUser.role || '').toLowerCase();
          isAdminEditor = empresaId === 1 || role === 'admin' || role === 'agent';
        } catch {}

        const headers = await apiHeaders();
        const r = await fetch(`/api/helpdesk/tickets/${ticketId}`, { credentials: 'include', headers });
        let t;
        if (!r.ok) {
          if (r.status === 401) { window.location.href = '/'; return; }
          // Fallback: try list endpoint and prefill from it
          const rl = await fetch(`/api/helpdesk/tickets?limit=200`, { credentials: 'include', headers });
          if (rl.ok) {
            const data = await rl.json();
            const found = (data.tickets || []).find(x => x.id === ticketId);
            if (found) {
              t = found;
              hideError();
            } else {
              showError('Sem permissão ou chamado não encontrado.');
              return;
            }
          } else {
            showError('Sem permissão para visualizar chamado.');
            return;
          }
        } else {
          t = await r.json();
        }
        // Derive empresa from ticket number pattern E{empresa}{ORIGIN}-{N} to grant admin edit when empresa=1
        try {
          if (!isAdminEditor && t && typeof t.numero === 'string') {
            const m = /^E(\d+)[A-Z]+-\d+$/i.exec(t.numero.trim());
            if (m && parseInt(m[1], 10) === 1) {
              isAdminEditor = true;
            }
          }
        } catch {}
        document.getElementById('ticketNumber').textContent = t.numero || `#${ticketId}`;
        document.getElementById('tituloInput').value = t.titulo || '';
        document.getElementById('descricaoInput').value = t.descricao || '';
        await loadStatusOptions(t.status_id || null);
        await loadPriorityOptions(t.prioridade_id || null);
        await loadAgentOptions((t.agente && t.agente.id) ? t.agente.id : null);
        await loadUserGreeting();

        // if not admin/agent, disable editing except comment
        if (!isAdminEditor) {
          document.getElementById('tituloInput').setAttribute('disabled', 'disabled');
          document.getElementById('descricaoInput').setAttribute('disabled', 'disabled');
          document.getElementById('statusSelect').setAttribute('disabled', 'disabled');
          document.getElementById('prioritySelect').setAttribute('disabled', 'disabled');
          document.getElementById('agenteSelect').setAttribute('disabled', 'disabled');
          showError('Você só pode adicionar comentários aos seus chamados.');
        } else {
          document.getElementById('errorBox').style.display = 'none';
          document.getElementById('tituloInput').removeAttribute('disabled');
          document.getElementById('descricaoInput').removeAttribute('disabled');
          document.getElementById('statusSelect').removeAttribute('disabled');
          document.getElementById('prioritySelect').removeAttribute('disabled');
          document.getElementById('agenteSelect').removeAttribute('disabled');
        }
      } catch (e) {
        showError('Erro ao carregar chamado');
      }
    }

    async function loadAgentOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/agente_contato_id?empresa_id=1', { credentials: 'include', headers });
        if (!r.ok) return; 
        const options = await r.json();
        const select = document.getElementById('agenteSelect');
        // Clear existing (keep first 'Não atribuído')
        select.innerHTML = '<option value="">Não atribuído</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function loadStatusOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/status_id', { credentials: 'include', headers });
        if (!r.ok) return;
        const options = await r.json();
        const select = document.getElementById('statusSelect');
        select.innerHTML = '<option value="">Selecione...</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function loadPriorityOptions(selectedId) {
      try {
        const headers = await apiHeaders();
        const r = await fetch('/admin/Chamado/foreign-key-options/prioridade_id', { credentials: 'include', headers });
        if (!r.ok) return;
        const options = await r.json();
        const select = document.getElementById('prioritySelect');
        select.innerHTML = '<option value="">Selecione...</option>' +
          options.map(o => `<option value="${o.id}">${o.display}</option>`).join('');
        if (selectedId) select.value = String(selectedId);
      } catch (e) { /* silent */ }
    }

    async function saveTicket() {
      hideError();
      try {
        const payload = {};
        const titulo = document.getElementById('tituloInput').value.trim();
        const descricao = document.getElementById('descricaoInput').value.trim();
        const statusId = document.getElementById('statusSelect').value;
        const prioridadeId = document.getElementById('prioritySelect').value;
        const agenteId = document.getElementById('agenteSelect').value;
        const comment = document.getElementById('commentInput').value;
        if (isAdminEditor) {
          if (titulo) payload.titulo = titulo;
          if (descricao) payload.descricao = descricao;
          if (statusId) payload.status_id = parseInt(statusId, 10);
          if (prioridadeId) payload.prioridade_id = parseInt(prioridadeId, 10);
          if (agenteId) payload.agente_contato_id = parseInt(agenteId, 10);
          if (comment) payload.comment = comment;
        } else {
          if (!comment || !comment.trim()) {
            throw new Error('Como solicitante, você só pode enviar comentários.');
          }
          payload.comment = comment.trim();
        }

        const headers = await apiHeaders();
        const r = await fetch(`/api/helpdesk/tickets/${ticketId}`, {
          method: 'PUT', credentials: 'include', headers, body: JSON.stringify(payload)
        });
        if (!r.ok) {
          let msg = 'Falha ao salvar alterações';
          try { const err = await r.json(); msg = err.detail || msg; } catch {}
          throw new Error(msg);
        }
        showSuccess('Chamado atualizado com sucesso');
        setTimeout(()=> { window.location.href = '/tickets'; }, 1000);
      } catch (e) { showError(e.message || 'Erro ao salvar'); }
    }

    document.getElementById('saveBtn').addEventListener('click', saveTicket);
    document.addEventListener('DOMContentLoaded', loadTicket);
  </script>
</body>
</html>
