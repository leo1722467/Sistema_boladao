{% extends 'base.html' %}
{% set sidebar_subtitle = 'Gestão de Inventário' %}
{% block title %}Gestão de Inventário - Sistema Boladão{% endblock %}
{% block extra_head %}
<style>
  .container { padding: 30px; max-width: 1400px; }
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
  .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #3498db; }
  .stat-title { font-size: 14px; color: #666; font-weight: 500; }
  .stat-value { font-size: 24px; font-weight: 700; color: #2c3e50; }
  .tickets-section { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; }
  .tickets-header { padding: 20px 25px; border-bottom: 1px solid #e9ecef; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
  .tickets-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
  .tickets-count { font-size: 14px; color: #666; background: #e9ecef; padding: 4px 12px; border-radius: 20px; }
  .filters-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-top: 25px; }
  .filters-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
  .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
  .filter-group { display: flex; flex-direction: column; }
  .filter-label { font-size: 14px; font-weight: 500; color: #555; margin-bottom: 8px; }
  .filter-input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
</style>
{% endblock %}
{% block topbar_left %}
<h1 class="page-title">Gestão de Inventário</h1>
{% endblock %}
{% block content %}
  <div class="stats-row">
    <div class="stat-card"><div class="stat-title">Total</div><div id="stockTotalCount" class="stat-value">--</div></div>
    <div class="stat-card"><div class="stat-title">Vinculados</div><div id="stockLinkedCount" class="stat-value">--</div></div>
    <div class="stat-card"><div class="stat-title">Disponível</div><div id="stockNewCount" class="stat-value">--</div></div>
  </div>
  <section class="tickets-section">
    <div class="tickets-header"><div class="tickets-title">Lista de Itens de Estoque</div><div id="stockCount" class="tickets-count">0 itens</div></div>
    <div id="inventoryTableContainer" class="table-container"></div>
  </section>
  <section class="filters-section">
    <div class="filters-title">Entrada de Inventário (Intake)</div>
    <div class="filters-grid">
      <div class="filter-group"><label class="filter-label">Catálogo (ID)</label><input id="intakeCatalogoInput" class="filter-input" placeholder="ID"></div>
      <div class="filter-group"><label class="filter-label">Serial</label><input id="intakeSerialInput" class="filter-input" placeholder="Serial"></div>
      <div class="filter-group"><label class="filter-label">Status Estoque (ID)</label><input id="intakeStatusInput" class="filter-input" placeholder="ID"></div>
      <div class="filter-group"><label class="filter-label">Quantidade</label><input id="intakeQtdInput" type="number" min="1" class="filter-input" placeholder="1"></div>
      <div class="filter-group"><label class="filter-label">Criar Ativo Automaticamente</label><input id="intakeAutoAssetInput" type="checkbox"></div>
    </div>
    <div class="filter-actions"><button id="intakeSubmitBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar Entrada</button></div>
    <div id="intakeResult" class="empty-state" style="display:none;"></div>
  </section>
{% endblock %}
{% block scripts %}
<script>
  let currentStock = []; let currentPage = 1; let totalPages = 1; let catalogMap = {}; let assetMap = {}; let statusMap = {}; let inventoryInitialized = false;
  document.addEventListener('DOMContentLoaded', function() { const hasToken = document.cookie.split('; ').some(row => row.startsWith('access_token=')); if (!hasToken) { window.location.href = '/'; return } document.getElementById('intakeSubmitBtn').addEventListener('click', submitIntake); loadReferenceMaps().then(() => loadInventory()); });
  async function loadReferenceMaps() { try { const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token=')); const token = tokenCookie ? tokenCookie.split('=')[1] : null; const headers = token ? { 'Authorization': `Bearer ${token}` } : {}; const [catRes, ativoRes, statusRes] = await Promise.all([ fetch('/admin/CatalogoPeca/items', { credentials: 'include', headers }), fetch('/admin/Ativo/items', { credentials: 'include', headers }), fetch('/admin/StatusEstoque/items', { credentials: 'include', headers }) ]); const [cats, ativos, statuses] = await Promise.all([ catRes.ok ? catRes.json() : [], ativoRes.ok ? ativoRes.json() : [], statusRes.ok ? statusRes.json() : [] ]); catalogMap = {}; Array.isArray(cats) && cats.forEach(c => { catalogMap[c.id] = c.nome || c.modelo || `Catálogo #${c.id}` }); assetMap = {}; Array.isArray(ativos) && ativos.forEach(a => { assetMap[a.id] = a.tag || a.descricao || `Ativo #${a.id}` }); statusMap = {}; Array.isArray(statuses) && statuses.forEach(s => { statusMap[s.id] = s.nome || `Status #${s.id}` }); } catch (e) { console.warn('Falha ao carregar mapas de referência', e) } }
  async function loadInventory(page = 1) { try { showLoading(); const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token=')); const token = tokenCookie ? tokenCookie.split('=')[1] : null; const headers = token ? { 'Authorization': `Bearer ${token}` } : {}; const response = await fetch('/admin/Estoque/items', { credentials: 'include', headers }); if (!response.ok) { let msg = 'Erro ao carregar inventário'; try { const err = await response.json(); if (response.status === 401) msg = 'Sessão expirada. Faça login novamente.'; else if (response.status === 403) msg = 'Sem permissão para visualizar inventário.'; else if (response.status === 400) msg = err.detail || 'Usuário sem empresa associada.'; } catch {} throw new Error(msg) } const data = await response.json(); currentStock = Array.isArray(data) ? data : []; updateStockStats(); updateStockCount(currentStock.length); renderInventoryTable(); } catch (error) { console.error('Error loading inventory:', error); showError(error.message || 'Erro ao carregar inventário') } }
  function showLoading() { document.getElementById('inventoryTableContainer').innerHTML = `<div class=\"loading\"><i class=\"fas fa-spinner fa-spin\"></i><p>Carregando inventário...</p></div>`; }
  function showError(message) { document.getElementById('inventoryTableContainer').innerHTML = `<div class=\"empty-state\"><i class=\"fas fa-exclamation-triangle\"></i><h3>Erro</h3><p>${message}</p></div>`; }
  function renderInventoryTable() { const container = document.getElementById('inventoryTableContainer'); const linked = currentStock.filter(it => !!it.vinculado_ativo_id); const unlinked = currentStock.filter(it => !it.vinculado_ativo_id); if (currentStock.length === 0) { container.innerHTML = `<div class=\"empty-state\"><i class=\"fas fa-boxes\"></i><h3>Nenhum item encontrado</h3><p>Não há itens que correspondam aos filtros aplicados.</p></div>`; return } if (!inventoryInitialized) { container.innerHTML = `<div class=\"tickets-header\" style=\"margin-top:16px;\"><div class=\"tickets-title\">Itens vinculados a Ativo</div><div id=\"linkedCount\" class=\"tickets-count\">0 itens</div></div><div class=\"filters-grid\" style=\"padding: 12px 25px;\"><div class=\"filter-group\" style=\"max-width: 480px;\"><label class=\"filter-label\">Buscar nesta lista</label><input id=\"linkedSearchInput\" class=\"filter-input\" placeholder=\"Buscar por qualquer campo\" style=\"flex:1;\" /></div></div><table class=\"tickets-table\"><thead><tr><th>ID</th><th>Catálogo</th><th>Serial</th><th>Status</th><th>Qtd</th><th>Ativo Vinculado</th></tr></thead><tbody id=\"linkedTbody\"></tbody></table><div class=\"tickets-header\" style=\"margin-top:24px;\"><div class=\"tickets-title\">Itens sem vínculo</div><div id=\"unlinkedCount\" class=\"tickets-count\">0 itens</div></div><div class=\"filters-grid\" style=\"padding: 12px 25px;\"><div class=\"filter-group\" style=\"max-width: 480px;\"><label class=\"filter-label\">Buscar nesta lista</label><input id=\"unlinkedSearchInput\" class=\"filter-input\" placeholder=\"Buscar por qualquer campo\" style=\"flex:1;\" /></div></div><table class=\"tickets-table\"><thead><tr><th>ID</th><th>Catálogo</th><th>Serial</th><th>Status</th><th>Qtd</th><th>Ativo Vinculado</th></tr></thead><tbody id=\"unlinkedTbody\"></tbody></table>`; inventoryInitialized = true; document.getElementById('linkedSearchInput').addEventListener('input', updateInventoryTables); document.getElementById('unlinkedSearchInput').addEventListener('input', updateInventoryTables); } updateInventoryTables(); }
  function updateInventoryTables() { const linkedSearchValue = (document.getElementById('linkedSearchInput')?.value || '').toLowerCase(); const unlinkedSearchValue = (document.getElementById('unlinkedSearchInput')?.value || '').toLowerCase(); const linked = currentStock.filter(it => !!it.vinculado_ativo_id); const unlinked = currentStock.filter(it => !it.vinculado_ativo_id); const matchItem = (it, search, includeAsset) => { if (!search) return true; const cat = catalogMap[it.catalogo_peca_id] || ''; const status = statusMap[it.status_estoque_id] || ''; const asset = includeAsset ? (assetMap[it.vinculado_ativo_id] || '') : ''; const text = `${it.id} ${it.catalogo_peca_id} ${cat} ${it.serial || ''} ${status} ${it.qtd || ''} ${asset}`.toLowerCase(); return text.includes(search) }; const linkedFiltered = linked.filter(it => matchItem(it, linkedSearchValue, true)); const unlinkedFiltered = unlinked.filter(it => matchItem(it, unlinkedSearchValue, false)); document.getElementById('linkedCount').textContent = `${linkedFiltered.length} itens`; document.getElementById('unlinkedCount').textContent = `${unlinkedFiltered.length} itens`; const linkedRows = linkedFiltered.map(it => `<tr><td>${it.id}</td><td>${catalogMap[it.catalogo_peca_id] ?? (it.catalogo_peca_id ?? '-')}</td><td>${it.serial ?? '-'}</td><td>${statusMap[it.status_estoque_id] ?? (it.status_estoque_id ?? '-')}</td><td>${it.qtd ?? '-'}</td><td>${assetMap[it.vinculado_ativo_id] ?? (it.vinculado_ativo_id ?? '-')}</td></tr>`).join(''); const unlinkedRows = unlinkedFiltered.map(it => `<tr><td>${it.id}</td><td>${catalogMap[it.catalogo_peca_id] ?? (it.catalogo_peca_id ?? '-')}</td><td>${it.serial ?? '-'}</td><td>${statusMap[it.status_estoque_id] ?? (it.status_estoque_id ?? '-')}</td><td>${it.qtd ?? '-'}</td><td>-</td></tr>`).join(''); document.getElementById('linkedTbody').innerHTML = linkedRows; document.getElementById('unlinkedTbody').innerHTML = unlinkedRows; }
  function updateStockStats() { const total = currentStock.length; const linked = currentStock.filter(it => it.vinculado_ativo_id).length; const news = currentStock.filter(it => it.novo === true).length; document.getElementById('stockTotalCount').textContent = total; document.getElementById('stockLinkedCount').textContent = linked; document.getElementById('stockNewCount').textContent = news; }
  function updateStockCount(count) { document.getElementById('stockCount').textContent = `${count} itens`; }
  function applyFilters() { loadInventory(1); }
  function clearFilters() { document.getElementById('serialInput').value=''; document.getElementById('catalogoInput').value=''; applyFilters(); }
  async function submitIntake() { try { const tokenCookie = document.cookie.split('; ').find(row => row.startsWith('access_token=')); const token = tokenCookie ? tokenCookie.split('=')[1] : null; const headers = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' }; const payload = { catalogo_peca_id: parseInt(document.getElementById('intakeCatalogoInput').value), serial: document.getElementById('intakeSerialInput').value, status_estoque_id: parseInt(document.getElementById('intakeStatusInput').value), qtd: parseInt(document.getElementById('intakeQtdInput').value || '1'), auto_create_asset: document.getElementById('intakeAutoAssetInput').checked }; const response = await fetch('/api/helpdesk/inventory/intake', { method: 'POST', credentials: 'include', headers, body: JSON.stringify(payload) }); if (!response.ok) { let msg = 'Erro ao registrar entrada'; try { const err = await response.json(); if (response.status === 401) msg = 'Sessão expirada. Faça login novamente.'; else if (response.status === 403) msg = 'Sem permissão para operar inventário.'; else if (response.status === 400) msg = err.detail || 'Dados inválidos.'; } catch {} throw new Error(msg) } const result = await response.json(); const resDiv = document.getElementById('intakeResult'); resDiv.style.display = 'block'; resDiv.innerHTML = `<i class=\"fas fa-check-circle\"></i><h3>Entrada registrada</h3><p>ID: ${result.estoque_id} · Serial: ${result.serial}</p>`; loadInventory(); } catch (error) { const resDiv = document.getElementById('intakeResult'); resDiv.style.display = 'block'; resDiv.innerHTML = `<i class=\"fas fa-exclamation-triangle\"></i><h3>Erro</h3><p>${error.message}</p>`; } }
</script>
{% endblock %}
