{% extends 'base.html' %}
{% set sidebar_subtitle = 'Admin KB' %}
{% block title %}Admin KB - Sistema Boladão{% endblock %}
{% block extra_head %}
<style>
  .container { padding:30px; max-width:1400px; }
  .card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); border:1px solid #e9ecef; margin-bottom:20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
  .form-group { flex:1; min-width:220px; }
  .label { display:block; font-size:13px; color:#666; margin-bottom:6px; }
  .input, .select, .textarea { width:100%; padding:10px; border:1px solid #e9ecef; border-radius:8px; font-size:14px; }
  .textarea { min-height:100px; }
  .actions { display:flex; gap:10px; margin-top:10px; }
  .btn { display:inline-flex; align-items:center; padding:10px 20px; border:none; border-radius:8px; font-size:14px; font-weight:500; text-decoration:none; cursor:pointer; transition:all .3s ease; }
  .btn-primary { background:linear-gradient(135deg,#3498db,#2980b9); color:white; }
  .btn-primary:hover { background:linear-gradient(135deg,#2980b9,#21618c); transform:translateY(-1px); }
  .btn i { margin-right:8px; }
  .success { color:#27ae60; margin-top:10px; }
</style>
{% endblock %}
{% block topbar_left %}
<h1 class="page-title">Gestão de Artigos</h1>
{% endblock %}
{% block content %}
  <div class="card">
    <div class="row">
      <input id="searchInput" class="input" placeholder="Buscar artigos por título/descrição" />
      <button class="btn btn-primary" id="reloadBtn"><i class="fas fa-rotate"></i> Recarregar</button>
      <a class="btn" href="/admin/KBArticle/create"><i class="fas fa-plus"></i> Novo Artigo</a>
      <a class="btn" href="/admin/KBArticle"><i class="fas fa-pen"></i> Gerenciar Artigos</a>
      <a class="btn" href="/admin/KBCategory"><i class="fas fa-folder"></i> Categorias</a>
    </div>
  </div>
  <div id="articlesBox" class="card"></div>
{% endblock %}
{% block scripts %}
<script>
  function getToken() {
    const m = document.cookie.match(/(?:^|; )access_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  async function fetchJSON(url, opts={}) {
    const token = getToken();
    const headers = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' };
    const res = await fetch(url, { credentials:'include', headers, ...opts });
    if (res.redirected && res.url && res.url.includes('/web/login')) {
      window.location.href = '/web/login';
      throw new Error('Not authenticated');
    }
    if (!res.ok) {
      if (res.status === 401) { window.location.href = '/web/login'; throw new Error('Not authenticated'); }
      throw new Error('Falha: '+res.status);
    }
    return await res.json();
  }
  async function loadArticles() {
    const items = await fetchJSON('/admin/KBArticle/items');
    window.__kb = items;
    renderArticles();
  }
  function renderArticles() {
    const q = (document.getElementById('searchInput').value || '').toLowerCase();
    const items = (window.__kb || []).filter(a => {
      const t = (a.titulo || '').toLowerCase();
      const r = (a.resumo || '').toLowerCase();
      return !q || t.includes(q) || r.includes(q);
    });
    const box = document.getElementById('articlesBox');
    if (!items.length) { box.innerHTML = '<div class="empty-state">Nenhum artigo</div>'; return; }
    box.innerHTML = items.map(a => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #e9ecef;">
        <div style="flex:1;">
          <div style="font-weight:600;color:#2c3e50;">${a.titulo}</div>
          <div style="color:#666;">${a.resumo || ''}</div>
          <div style="color:#666;font-size:12px;">Visibilidade: ${a.visibilidade || 'external'} · Publicado: ${a.publicado ? 'Sim' : 'Não'}</div>
        </div>
        <a class="btn" href="/admin/KBArticle/${a.id}"><i class="fas fa-edit"></i> Editar</a>
        <button class="btn" onclick="togglePublish(${a.id}, ${a.publicado ? 'false' : 'true'})">${a.publicado ? 'Despublicar' : 'Publicar'}</button>
        <button class="btn" onclick="setVisibility(${a.id}, '${(a.visibilidade||'external')==='external'?'internal':'external'}')">Tornar ${(a.visibilidade||'external')==='external'?'Interno':'Externo'}</button>
      </div>
    `).join('');
  }
  async function togglePublish(id, value) {
    await fetchJSON(`/admin/KBArticle/items/${id}`, { method:'PUT', body: JSON.stringify({ publicado: !!value }) });
    await loadArticles();
  }
  async function setVisibility(id, value) {
    await fetchJSON(`/admin/KBArticle/items/${id}`, { method:'PUT', body: JSON.stringify({ visibilidade: value }) });
    await loadArticles();
  }
  document.getElementById('reloadBtn').onclick = loadArticles;
  document.getElementById('searchInput').addEventListener('input', renderArticles);
  loadArticles();
</script>
{% endblock %}
