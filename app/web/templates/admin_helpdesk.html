{% extends 'base.html' %}
{% set sidebar_subtitle = 'Gestão de Helpdesk' %}
{% block title %}Admin Helpdesk - Sistema Boladão{% endblock %}
{% block extra_head %}
<style>
  .container { padding:30px; max-width:1400px; }
  .card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); border:1px solid #e9ecef; margin-bottom:20px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
  .form-group { flex:1; min-width:220px; }
  .label { display:block; font-size:13px; color:#666; margin-bottom:6px; }
  .input, .select, .textarea { width:100%; padding:10px; border:1px solid #e9ecef; border-radius:8px; font-size:14px; }
  .textarea { min-height:100px; }
  .actions { display:flex; gap:10px; margin-top:10px; }
  .tickets-nav { display: flex; gap: 10px; padding: 12px 0; border-bottom: 1px solid #e9ecef; margin-bottom: 16px; }
  .tickets-nav .nav-item { display: inline-flex; align-items: center; padding: 8px 14px; border-radius: 20px; border: 1px solid #e0e0e0; background: #fff; color: #2c3e50; cursor: pointer; font-size: 14px; text-decoration: none; }
  .tickets-nav .nav-item.active { background: #3498db; color: #fff; border-color: #3498db; }
  .tickets-nav .nav-item i { margin-right: 8px; }
  .inline-admin { margin-top:12px; border:1px solid #e9ecef; border-radius:8px; overflow:hidden; background:#fff; }
  .inline-admin iframe { width:100%; min-height:620px; border:0; background:#fff; }
</style>
{% endblock %}
{% block topbar_left %}
<div>
  <h1 class="page-title">Admin Helpdesk</h1>
  <div class="tickets-nav" style="margin-top:8px;">
    <a class="nav-item" href="/tickets"><i class="fas fa-layer-group"></i>Todos</a>
    <a class="nav-item" href="/tickets?status=open"><i class="fas fa-folder-open"></i>Abertos</a>
    <a class="nav-item" href="/tickets?status=closed"><i class="fas fa-archive"></i>Fechados</a>
    <a class="nav-item active" href="/admin/helpdesk"><i class="fas fa-tools"></i>Admin Helpdesk</a>
  </div>
</div>
{% endblock %}
{% block content %}

  <h2>Dados Básicos</h2>
  <div class="card">
    <div class="actions">
      <button class="btn" id="newCatBtn">Nova Categoria</button>
      <button class="btn" id="newPriBtn">Nova Prioridade</button>
      <button class="btn" id="newAgentBtn">Novo Agente</button>
      <button class="btn" id="refreshOptsBtn">Atualizar listas</button>
      <button class="btn" id="newStatusBtn">Novo Status</button>
      <button class="btn" id="newDefeitoBtn">Novo Defeito</button>
    </div>
    <div id="inlineAdminBox" class="inline-admin"></div>
  </div>

  <h2>Roteamento</h2>
  <div id="routingBox" class="card"></div>
  <div class="actions">
    <button class="btn" id="addRoutingBtn">Adicionar Regra</button>
    <button class="btn btn-primary" id="saveRoutingBtn">Salvar Roteamento</button>
  </div>

  <h2>Macros</h2>
  <div id="macrosBox" class="card"></div>
  <div class="actions">
    <button class="btn" id="addMacroBtn">Adicionar Macro</button>
    <button class="btn btn-primary" id="saveMacrosBtn">Salvar Macros</button>
  </div>

  <h2>SLA Overrides</h2>
  <div id="slaBox" class="card"></div>
  <div class="actions">
    <button class="btn btn-primary" id="saveSlaBtn">Salvar SLA</button>
  </div>

  <h2>Fechamento Automático</h2>
  <div id="autoCloseBox" class="card"></div>
  <div class="actions">
    <button class="btn btn-primary" id="saveAutoCloseBtn">Salvar Política</button>
    <button class="btn" id="runAutoCloseBtn">Executar agora</button>
  </div>
  <div id="statusBox" class="success"></div>
{% endblock %}
{% block scripts %}
<script>
  function getAccessToken() {
    const m = document.cookie.match(/(?:^|; )access_token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  async function fetchJSON(url, opts={}) {
    const token = getAccessToken();
    const baseHeaders = {'Content-Type':'application/json'};
    if (token) baseHeaders['Authorization'] = `Bearer ${token}`;
    const res = await fetch(url, {credentials:'include', headers: baseHeaders, ...opts});
    if (res.redirected) {
      window.location.href = '/';
      return Promise.reject(new Error('Not authenticated'));
    }
    if (!res.ok) {
      if (res.status === 401) { window.location.href = '/'; return Promise.reject(new Error('Not authenticated')); }
      throw new Error('Falha: '+res.status);
    }
    return await res.json();
  }
  function select(name, options, value) {
    const s = document.createElement('select');
    s.className = 'select';
    s.dataset.name = name;
    const optNone = document.createElement('option');
    optNone.value = '';
    optNone.textContent = '—';
    s.appendChild(optNone);
    options.forEach(o => {
      const opt = document.createElement('option');
      opt.value = String(o.id);
      opt.textContent = o.nome;
      s.appendChild(opt);
    });
    s.value = value ? String(value) : '';
    return s;
  }
  function input(name, value, type='text') { const i = document.createElement('input'); i.className='input'; i.dataset.name=name; i.type=type; i.value=value!=null?String(value):''; return i; }
  function checkbox(name, checked) { const c=document.createElement('input'); c.type='checkbox'; c.dataset.name=name; c.checked=!!checked; return c; }
  function textarea(name, value) { const t=document.createElement('textarea'); t.className='textarea'; t.dataset.name=name; t.value=value!=null?String(value):''; return t; }
  function row(fields) { const r=document.createElement('div'); r.className='row'; fields.forEach(f=>{ const fg=document.createElement('div'); fg.className='form-group'; const label=document.createElement('label'); label.className='label'; label.textContent=f.label; fg.appendChild(label); fg.appendChild(f.el); r.appendChild(fg); }); return r; }
  async function loadOptions() {
    const cats = await fetchJSON('/admin/ChamadoCategoria/items');
    const pris = await fetchJSON('/admin/Prioridade/items');
    const agents = await fetchJSON('/admin/Contato/items');
    const tiposAtivo = await fetchJSON('/admin/TipoAtivo/items');
    window.__opts = {
      categorias: (cats.items || cats || []).map(x => ({id: x.id, nome: x.nome})),
      prioridades: (pris.items || pris || []).map(x => ({id: x.id, nome: x.nome})),
      agentes: (agents.items || agents || []).map(x => ({id: x.id, nome: x.nome})),
      tiposAtivo: (tiposAtivo.items || tiposAtivo || []).map(x => ({id: x.id, nome: x.nome})),
    };
  }
  async function loadAll() {
    await loadOptions();
    const routing = await fetchJSON('/admin/helpdesk/routing');
    const macros = await fetchJSON('/admin/helpdesk/macros');
    const sla = await fetchJSON('/admin/helpdesk/sla-overrides');
    const autoClose = await fetchJSON('/admin/helpdesk/auto-close');
    const rb = document.getElementById('routingBox');
    const mb = document.getElementById('macrosBox');
    const sb = document.getElementById('slaBox');
    const ab = document.getElementById('autoCloseBox');
    rb.innerHTML=''; mb.innerHTML=''; sb.innerHTML=''; ab.innerHTML='';
    window.__routing = routing.rules || [];
    window.__macros = macros.macros || [];
    window.__sla = sla.overrides || [];
    window.__autoClose = autoClose;
    renderRouting();
    renderMacros();
    renderSLA();
    renderAutoClose();
  }
  function renderRouting() {
    const box = document.getElementById('routingBox');
    box.innerHTML='';
    window.__routing.forEach((r, idx) => {
      const elCat = select('categoria_id', window.__opts.categorias, r.categoria_id);
      const elPri = select('prioridade_id', window.__opts.prioridades, r.prioridade_id);
      const elAgent = select('agente_contato_id', window.__opts.agentes, r.agente_contato_id);
      const elActive = checkbox('ativo', r.ativo);
      const removeBtn = document.createElement('button'); removeBtn.className='btn'; removeBtn.textContent='Remover'; removeBtn.onclick = () => { window.__routing.splice(idx,1); renderRouting(); };
      const rEl = row([
        {label:'Categoria', el: elCat},
        {label:'Prioridade', el: elPri},
        {label:'Agente', el: elAgent},
        {label:'Ativo', el: elActive},
      ]);
      const actions = document.createElement('div'); actions.className='actions'; actions.appendChild(removeBtn);
      box.appendChild(rEl); box.appendChild(actions);
      elCat.onchange = () => r.categoria_id = elCat.value ? parseInt(elCat.value) : null;
      elPri.onchange = () => r.prioridade_id = elPri.value ? parseInt(elPri.value) : null;
      elAgent.onchange = () => r.agente_contato_id = elAgent.value ? parseInt(elAgent.value) : null;
      elActive.onchange = () => r.ativo = elActive.checked;
    });
  }
  function renderMacros() {
    const box = document.getElementById('macrosBox'); box.innerHTML='';
    window.__macros.forEach((m, idx) => {
      const elNome = input('nome', m.nome); const elDesc = input('descricao', m.descricao); const elActions = textarea('actions', JSON.stringify(m.actions || {}, null, 2));
      const removeBtn = document.createElement('button'); removeBtn.className='btn'; removeBtn.textContent='Remover'; removeBtn.onclick = () => { window.__macros.splice(idx,1); renderMacros(); };
      const rEl = row([{label:'Nome', el: elNome},{label:'Descrição', el: elDesc}]);
      const taEl = document.createElement('div'); taEl.className='form-group'; const lab = document.createElement('label'); lab.className='label'; lab.textContent='Ações (JSON)'; taEl.appendChild(lab); taEl.appendChild(elActions);
      const actions = document.createElement('div'); actions.className='actions'; actions.appendChild(removeBtn);
      box.appendChild(rEl); box.appendChild(taEl); box.appendChild(actions);
      elNome.oninput = () => m.nome = elNome.value; elDesc.oninput = () => m.descricao = elDesc.value; elActions.oninput = () => { try { m.actions = JSON.parse(elActions.value || '{}'); } catch(e){} };
    });
  }
  function renderSLA() {
    const box = document.getElementById('slaBox'); box.innerHTML=''; const priorities = window.__opts.prioridades;
    priorities.forEach(p => {
      let ov = window.__sla.find(o => o.prioridade_id === p.id); if (!ov) { ov = {prioridade_id: p.id, response_hours: 24, resolution_hours: 72, escalation_hours: 48}; window.__sla.push(ov); }
      const elResp = input('response_hours', ov.response_hours, 'number'); const elRes = input('resolution_hours', ov.resolution_hours, 'number'); const elEsc = input('escalation_hours', ov.escalation_hours, 'number');
      const elPriName = input('prioridade_nome', p.nome); elPriName.disabled = true;
      const rEl = row([{label:'Prioridade', el: elPriName},{label:'Resposta (h)', el: elResp},{label:'Resolução (h)', el: elRes},{label:'Escalonamento (h)', el: elEsc}]);
      box.appendChild(rEl);
      elResp.oninput = () => ov.response_hours = parseInt(elResp.value || '0'); elRes.oninput = () => ov.resolution_hours = parseInt(elRes.value || '0'); elEsc.oninput = () => ov.escalation_hours = parseInt(elEsc.value || '0');
    });
  }
  function renderAutoClose() {
    const box = document.getElementById('autoCloseBox'); box.innerHTML='';
    const elEnabled = checkbox('enabled', window.__autoClose.enabled); const elPend = input('pending_customer_days', window.__autoClose.pending_customer_days, 'number'); const elRes = input('resolved_days', window.__autoClose.resolved_days, 'number');
    const rEl = row([{label:'Ativo', el: elEnabled},{label:'Dias em espera', el: elPend},{label:'Dias resolvido', el: elRes}]); box.appendChild(rEl);
    elEnabled.onchange = () => window.__autoClose.enabled = elEnabled.checked; elPend.oninput = () => window.__autoClose.pending_customer_days = parseInt(elPend.value || '0'); elRes.oninput = () => window.__autoClose.resolved_days = parseInt(elRes.value || '0');
  }
  document.addEventListener('DOMContentLoaded', () => {
    function openInline(url) {
      const box = document.getElementById('inlineAdminBox');
      if (!box) return;
      box.innerHTML = `<iframe src="${url}" loading="eager"></iframe>`;
    }
    function openCreate(model) {
      const box = document.getElementById('inlineAdminBox');
      if (!box) return;
      box.innerHTML = '';
      const formBox = document.createElement('div');
      const title = document.createElement('h3');
      title.textContent = `Criar ${model}`;
      formBox.appendChild(title);
      let fields = [];
      if (model === 'ChamadoCategoria') {
        const elNome = input('nome', ''); const elDesc = input('descricao', ''); const elCor = input('cor','');
        fields = [{label:'Nome', el: elNome},{label:'Descrição', el: elDesc},{label:'Cor', el: elCor}];
      } else if (model === 'Prioridade') {
        const elNome = input('nome',''); const elSla = input('sla_padrao_min','', 'number');
        fields = [{label:'Nome', el: elNome},{label:'SLA padrão (min)', el: elSla}];
      } else if (model === 'StatusChamado') {
        const elNome = input('nome',''); const elDesc = input('descricao',''); const elCor = input('cor',''); const elAtivo = checkbox('ativo', true);
        fields = [{label:'Nome', el: elNome},{label:'Descrição', el: elDesc},{label:'Cor', el: elCor},{label:'Ativo', el: elAtivo}];
      } else if (model === 'ChamadoDefeito') {
        const elNome = input('nome',''); const elTipo = select('tipo_ativo_id', (window.__opts && window.__opts.tiposAtivo) || [], null);
        fields = [{label:'Nome', el: elNome},{label:'Tipo de Ativo', el: elTipo}];
      } else if (model === 'Contato') {
        const elNome = input('nome',''); const elEmail = input('email',''); const elTel = input('telefone','');
        fields = [{label:'Nome', el: elNome},{label:'Email', el: elEmail},{label:'Telefone', el: elTel}];
      }
      const rEl = row(fields);
      formBox.appendChild(rEl);
      const actions = document.createElement('div'); actions.className = 'actions';
      const btnSalvar = document.createElement('button'); btnSalvar.className='btn btn-primary'; btnSalvar.textContent='Salvar';
      const btnCancelar = document.createElement('button'); btnCancelar.className='btn'; btnCancelar.textContent='Cancelar';
      actions.appendChild(btnSalvar); actions.appendChild(btnCancelar);
      formBox.appendChild(actions);
      box.appendChild(formBox);
      btnCancelar.onclick = () => { box.innerHTML = ''; };
      btnSalvar.onclick = async () => {
        const data = {};
        Array.from(rEl.querySelectorAll('[data-name]')).forEach(el => {
          const name = el.dataset.name;
          let val = el.type === 'checkbox' ? el.checked : el.value;
          if (el.type === 'number') { val = el.value ? parseInt(el.value) : null; }
          if (val === '') val = null;
          data[name] = val;
        });
        try {
          await fetchJSON(`/admin/${model}/items`, {method:'POST', body: JSON.stringify(data)});
          document.getElementById('statusBox').textContent = `${model} criado`;
          box.innerHTML = '';
          if (model === 'ChamadoCategoria' || model === 'Prioridade' || model === 'Contato') { try { await loadOptions(); renderRouting(); renderMacros(); renderSLA(); } catch(e){} }
        } catch(e) {
          document.getElementById('statusBox').textContent = `Falha ao criar ${model}`;
        }
      };
    }
    document.getElementById('saveRoutingBtn').onclick = async () => { await fetchJSON('/admin/helpdesk/routing', {method:'PUT', body:JSON.stringify({rules: window.__routing})}); document.getElementById('statusBox').textContent = 'Roteamento salvo'; };
    document.getElementById('refreshOptsBtn').onclick = async () => { try { await loadOptions(); renderRouting(); renderMacros(); renderSLA(); } catch(e){} };
    document.getElementById('newCatBtn').onclick = () => { openCreate('ChamadoCategoria'); };
    document.getElementById('newPriBtn').onclick = () => { openCreate('Prioridade'); };
    document.getElementById('newAgentBtn').onclick = () => { openCreate('Contato'); };
    document.getElementById('newStatusBtn').onclick = () => { openCreate('StatusChamado'); };
    document.getElementById('newDefeitoBtn').onclick = () => { openCreate('ChamadoDefeito'); };
    document.getElementById('addRoutingBtn').onclick = async () => { if (!window.__opts) { try { await loadOptions(); } catch(e){} } window.__routing.push({categoria_id: null, prioridade_id: null, agente_contato_id: null, ativo: true}); renderRouting(); };
    document.getElementById('saveMacrosBtn').onclick = async () => { await fetchJSON('/admin/helpdesk/macros', {method:'PUT', body:JSON.stringify({macros: window.__macros})}); document.getElementById('statusBox').textContent = 'Macros salvas'; };
    document.getElementById('addMacroBtn').onclick = () => { window.__macros.push({nome: '', descricao: '', actions: {}}); renderMacros(); };
    document.getElementById('saveSlaBtn').onclick = async () => { await fetchJSON('/admin/helpdesk/sla-overrides', {method:'PUT', body:JSON.stringify({overrides: window.__sla})}); document.getElementById('statusBox').textContent = 'SLA salvo'; };
    document.getElementById('saveAutoCloseBtn').onclick = async () => { await fetchJSON('/admin/helpdesk/auto-close', {method:'PUT', body:JSON.stringify(window.__autoClose)}); document.getElementById('statusBox').textContent = 'Política de fechamento salva'; };
    document.getElementById('runAutoCloseBtn').onclick = async () => { const data = await fetchJSON('/admin/helpdesk/run-auto-close', {method:'POST'}); document.getElementById('statusBox').textContent = `Fechados: ${data.closed}`; };
    (async () => { try { await loadAll(); } catch(e) { window.__opts = {categorias:[], prioridades:[], agentes:[]}; window.__routing = []; window.__macros = []; window.__sla = []; window.__autoClose = {enabled:false,pending_customer_days:14,resolved_days:7}; renderRouting(); renderMacros(); renderSLA(); renderAutoClose(); } })();
  });
</script>
{% endblock %}
